<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏î‡∏∏‡∏Å‡∏ó‡∏≠‡∏î</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/Order_page.css') }}"
    />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="cart-popup-backdrop" id="cart-backdrop"></div>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
      <a
        class="navbar-brand"
        href="#"
        id="nav-menu"
        onclick="toggleCategoriesNav()"
        >‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚¨á</a
      >
      <div class="ml-auto">
        <button class="btn btn-link text-white" onclick="toggleSearchPopup()">
          üîç
        </button>
        <button class="btn btn-link text-white" onclick="toggleCartPopup()">
          üõí <span id="cart-count" class="badge badge-warning">0</span>
        </button>
      </div>
    </nav>

    <!-- Categories Navigation -->
    <div
      class="categories-nav bg-danger p-3"
      id="categories-nav"
      style="display: none"
    ></div>

    <!-- Search Bar -->
    <div
      class="search-bar-bottom bg-danger p-3 justify-content-center"
      id="search-bar-bottom"
      style="display: none"
    >
      <input
        type="text"
        class="form-control"
        id="search-input-bottom"
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£..."
      />
      <button class="btn btn-warning ml-2" onclick="toggleSearchPopup()">
        Close
      </button>
    </div>

    <!-- Menu Grid -->
    <div class="container mt-4" id="menu-grid-container"></div>

    <!-- Product Popup -->
    <div class="cart-popup-item" id="product-popup">
      <div class="popup-content">
        <img id="product-image" src="" alt="Product Image" class="img-fluid" />
        <h3 id="product-name" class="mt-3"></h3>
        <p id="product-description"></p>
        <p id="product-price"></p>
        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <div class="form-group">
          <label for="quantity-input">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
          <input
            type="number"
            id="quantity-input"
            class="form-control"
            value="1"
            min="1"
          />
        </div>
        <button class="btn btn-warning mt-2" onclick="closeProductPopup()">
          ‡∏õ‡∏¥‡∏î
        </button>
        <button
          id="add-from-popup"
          class="btn btn-warning mt-2"
          onclick="addToCartFromPopup()"
        >
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        </button>
      </div>
    </div>

    <!-- Cart Popup -->
    <div class="cart-popup" id="cart-popup">
      <button
        class="close-button btn btn-link text-dark float-right"
        onclick="toggleCartPopup()"
      >
        √ó
      </button>
      <h2>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <div id="cart-items"></div>
      <div class="text-right">
        <div id="total-price" class="mt-3 font-weight-bold">
          ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ö‡∏≤‡∏ó
        </div>
        <button class="btn btn-danger" onclick="clearcart()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="btn btn-warning" onclick="checkout()">
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        </button>
      </div>
    </div>

    <script>
      let menuItems = []; // Array to store menu items
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      $(document).ready(function () {
        (function () {
          $.getJSON("/menu/menus", populate_table);
        })();
        updateCart(); // Update the cart count

        // Add event listener for search input
        $("#search-input-bottom").on("input", function () {
          const searchTerm = $(this).val().toLowerCase();
          const filteredItems = menuItems.filter((item) =>
            item.name.toLowerCase().includes(searchTerm)
          );
          renderMenuByCategory(filteredItems);
        });
      });

      // Fetch menu data from the API
      function populate_table(data) {
        menuItems = data;
        renderMenuByCategory();
        renderCategoriesNav();
      }

      // Render categories dynamically
      function renderCategoriesNav() {
        const categoriesNav = $("#categories-nav");
        categoriesNav.empty(); // Clear existing categories

        // Get unique categories from the menu items
        const categories = [...new Set(menuItems.map((item) => item.category))];

        console.log(categories);
        // Add an "All" category option
        categoriesNav.append(`
    <a href="javascript:void(0)" class="d-block text-white mb-2" onclick="filterMenucat('')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
  `);

        // Loop through the unique categories and add them to the navigation
        categories.forEach((category) => {
          categoriesNav.append(`
      <a href="javascript:void(0)" class="d-block text-white mb-2" onclick="filterMenucat('${category}')">${category}</a>
    `);
        });
      }
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏ô‡∏π
      function renderMenuByCategory(filteredItems = menuItems) {
        const menuContainer = $("#menu-grid-container");
        menuContainer.empty(); // Clear existing items

        const groupedByCategory = filteredItems.reduce((acc, item) => {
          acc[item.category] = acc[item.category] || [];
          acc[item.category].push(item);
          return acc;
        }, {});

        Object.keys(groupedByCategory).forEach((category) => {
          const categoryContainer = $("<div>").addClass("mb-4");

          const categoryTitle = $("<h3>")
            .addClass("text-danger font-weight-bold mb-3")
            .text(category);
          categoryContainer.append(categoryTitle);

          const gridContainer = $("<div>").addClass("row");

          groupedByCategory[category].forEach((item) => {
            const cardDiv = $("<div>").addClass("col-md-4 mb-4");
            cardDiv.html(`
        <div class="card">
          <img src="${item.image_url}" class="card-img-top" alt="${item.name}">
          <div class="card-body">
            <h5 class="card-title">${item.name}</h5>
            <p class="card-text">‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price} ‡∏ö‡∏≤‡∏ó</p>
            <div class="form-group">
              <label for="quantity-input-${item.id}">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
              <input
                type="number"
                id="quantity-input-${item.id}"
                class="form-control"
                value="1"
                min="1"
              />
            </div>
            <button class="btn btn-warning btn-block" onclick="addToCart(${item.id}, parseInt($('#quantity-input-${item.id}').val(), 10))">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
            <button class="btn btn-outline-secondary btn-block" onclick="showProductPopup(${item.id})">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
          </div>
        </div>
      `);
            gridContainer.append(cardDiv);
          });

          categoryContainer.append(gridContainer);
          menuContainer.append(categoryContainer);
        });
      }

      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCart ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      function addToCart(itemId, quantity = 1) {
        const item = menuItems.find((menuItem) => menuItem.id === itemId);
        if (!item) return;

        const existingItem = cart.find((cartItem) => cartItem.id === itemId);
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({ ...item, quantity: quantity });
        }

        updateCart();
      }

      // Update cart function
      function updateCart() {
        localStorage.setItem("cart", JSON.stringify(cart));

        // Calculate total quantity of items in cart
        const totalQuantity = cart.reduce(
          (acc, item) => acc + item.quantity,
          0
        );
        $("#cart-count").text(totalQuantity);

        renderCart();
      }

      // Render cart function
      function renderCart() {
        const cartItemsDiv = $("#cart-items");
        const totalPriceDiv = $("#total-price");

        cartItemsDiv.empty();
        let totalPrice = 0;

        cart.forEach((item) => {
          const cartItemDiv = $("<div>").addClass("cart-item");
          cartItemDiv.html(`
            <span>${item.name}</span>
            <div class="quantity-buttons">
              <button class="btn btn-sm btn-danger" onclick="changeQuantity(${item.id}, -1)">-</button>
              <span>${item.quantity}</span>
              <button class="btn btn-sm btn-success" onclick="changeQuantity(${item.id}, 1)">+</button>
              <button class="btn btn-sm btn-danger" onclick="removeItem(${item.id})">üóëÔ∏è</button>
            </div>
          `);
          cartItemsDiv.append(cartItemDiv);
          totalPrice += item.price * item.quantity;
        });

        totalPriceDiv.text(`‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalPrice} ‡∏ö‡∏≤‡∏ó`);
      }

      // Change quantity function
      function changeQuantity(itemId, change) {
        const item = cart.find((cartItem) => cartItem.id === itemId);
        if (!item) return;

        item.quantity += change;
        if (item.quantity <= 0) {
          cart = cart.filter((cartItem) => cartItem.id !== itemId);
        }
        updateCart();
      }

      // Remove item function
      function removeItem(itemId) {
        cart = cart.filter((cartItem) => cartItem.id !== itemId);
        updateCart();
      }

      // Checkout function
      function checkout() {
        alert("‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß!");
        cart = [];
        updateCart();
        toggleCartPopup();
      }

      // Clear cart function
      function clearcart() {
        cart = [];
        updateCart();
      }

      // Toggle search popup function
      function toggleSearchPopup() {
        $("#search-bar-bottom").css("display", function (i, v) {
          return v === "none" ? "flex" : "none";
        });
        $("#search-input-bottom").focus();
      }

      // Toggle cart popup function
      function toggleCartPopup() {
        $("#cart-popup").toggleClass("show");
        $("#cart-backdrop").toggle(); // Show or hide the backdrop
      }

      // Toggle categories navigation function
      function toggleCategoriesNav() {
        $("#categories-nav").toggle();
      }

      // Filter menu by category
      function filterMenucat(category) {
        let filteredItems = menuItems;
        if (category) {
          filteredItems = menuItems.filter(
            (item) => item.category === category
          );
        }
        renderMenuByCategory(filteredItems);
        toggleCategoriesNav();
      }

      // Show product popup function
      function showProductPopup(productId) {
        const product = menuItems.find((item) => item.id === productId);
        if (!product) return;

        // Display product details in the popup
        $("#product-image").attr("src", product.image_url);
        $("#product-name").text(product.name);
        $("#product-description").text(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${product.name}`);
        $("#product-price").text(`‡∏£‡∏≤‡∏Ñ‡∏≤: ${product.price} ‡∏ö‡∏≤‡∏ó`);
        $("#add-from-popup").data("product-id", productId);

        // Open the popup
        $("#product-popup").addClass("show");
      }

      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCartFromPopup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å input
      function addToCartFromPopup() {
        const productId = $("#add-from-popup").data("product-id");
        const quantity = parseInt($("#quantity-input").val(), 10);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (quantity > 0) {
          addToCart(productId, quantity);
          closeProductPopup(); // ‡∏õ‡∏¥‡∏î‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        } else {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
        }
      }

      // Close product popup function
      function closeProductPopup() {
        $("#product-popup").removeClass("show");
      }
    </script>
  </body>
</html>
