<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏î‡∏∏‡∏Å‡∏ó‡∏≠‡∏î</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/Order_page.css') }}"
    />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>

  <body>
    <!-- Toast Notification -->
    <div
      class="toast position-fixed bottom-0 right-0 p-3"
      style="z-index: 1055; bottom: 1rem; right: 1rem"
      id="cart-toast"
      data-delay="2000"
    >
      <div class="toast-body">
        <i class="fas fa-check-circle"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤!
      </div>
    </div>
    <!-- Toast Notification for item removal -->
    <div
      class="toast position-fixed bottom-0 right-0 p-3"
      style="z-index: 1060; bottom: 1rem; right: 1rem; background-color: red"
      id="remove-toast"
      data-delay="2000"
    >
      <div class="toast-body" style="background-color: red">
        <i class="fas fa-trash-alt"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤!
      </div>
    </div>
    <!-- Toast Notification for all item removal -->
    <div
      class="toast position-fixed bottom-0 right-0 p-3"
      style="z-index: 1060; bottom: 1rem; right: 1rem; background-color: red"
      id="remove-all-toast"
      data-delay="2000"
    >
      <div class="toast-body" style="background-color: red">
        <i class="fas fa-trash-alt"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤!
      </div>
    </div>

    <div class="cart-popup-backdrop" id="cart-backdrop"></div>
    <!-- Navbar -->
    <nav class="navbar navbar-expand navbar-dark bg-danger">
      <img
        class="mr-2 logo-animation"
        src="/static/ico/logo.jpg"
        style="height: 40px; border-radius: 20px"
        alt="logo"
      />
      <div class="navbar-nav">
        <div class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle text-white"
            href="#"
            id="nav-menu"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£
          </a>
          <ul
            class="dropdown-menu fade-in-animation"
            aria-labelledby="nav-menu"
            id="categories-dropdown"
          ></ul>
        </div>
      </div>

      <div class="ml-auto">
        <button
          class="btn btn-link text-white animate-on-hover"
          onclick="toggleSearchPopup()"
        >
          üîç
        </button>
        <button
          class="btn btn-link text-white animate-on-hover"
          onclick="toggleCartPopup()"
        >
          üõí <span id="cart-count" class="badge badge-warning">0</span>
        </button>
      </div>
    </nav>

    <!-- Search Bar -->
    <div
      class="search-bar-bottom bg-danger p-3 justify-content-center"
      id="search-bar-bottom"
      style="display: none"
    >
      <input
        type="text"
        class="form-control"
        id="search-input-bottom"
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£..."
      />
      <button class="btn btn-warning ml-2" onclick="toggleSearchPopup()">
        Close
      </button>
    </div>

    <!-- Menu Grid -->
    <!-- <button id="toggle-view-btn" class="btn btn-primary mb-3">
      Switch to List View
    </button> -->
    <div class="container mt-4" id="menu-grid-container"></div>

    <!-- Product Popup -->
    <div class="cart-popup-item" id="product-popup">
      <div class="popup-content">
        <img id="product-image" src="" alt="Product Image" class="img-fluid" />
        <h3 id="product-name" class="mt-3"></h3>
        <p id="product-description"></p>
        <p id="product-price"></p>
        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <div class="form-group">
          <label for="quantity-input">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
          <input
            type="number"
            id="quantity-input"
            class="form-control"
            value="1"
            min="1"
          />
        </div>
        <button class="btn btn-danger mt-2" onclick="closeProductPopup()">
          ‡∏õ‡∏¥‡∏î
        </button>
        <button
          id="add-from-popup"
          class="btn btn-warning mt-2"
          onclick="addToCartFromPopup()"
        >
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        </button>
      </div>
    </div>

    <!-- Cart Popup -->
    <div class="cart-popup" id="cart-popup">
      <button
        class="close-button btn btn-link text-dark float-right"
        onclick="toggleCartPopup()"
      >
        √ó
      </button>
      <h2>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <div id="cart-items"></div>
      <div class="text-right">
        <div id="total-price" class="mt-3 font-weight-bold">
          ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ö‡∏≤‡∏ó
        </div>
        <button class="btn btn-danger" onclick="clearcart()">üóëÔ∏è ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="btn btn-warning" onclick="checkout()">
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        </button>
      </div>
    </div>

    <script>
      // window.history.replaceState({}, document.title, '/order_food')
      let menuItems = []; // Array to store menu items
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      $(document).ready(function () {
        (function () {
          $.getJSON("/menu/menus", populate_table);
        })();
        console.log("{{ table_id }}");
        updateCart(); // Update the cart count

        // Add event listener for search input
        $("#search-input-bottom").on("input", function () {
          const searchTerm = $(this).val().toLowerCase();
          const filteredItems = menuItems.filter((item) =>
            item.name.toLowerCase().includes(searchTerm)
          );
          renderMenuByCategory(filteredItems);
        });
      });

      // Fetch menu data from the API
      function populate_table(data) {
        menuItems = data;
        renderMenuByCategory();
        renderCategoriesNav();
      }

      // Render categories dynamically for the dropdown menu
      function renderCategoriesNav() {
        const categoriesDropdown = $("#categories-dropdown");
        categoriesDropdown.empty(); // Clear existing categories

        // Get unique categories from the menu items
        const categories = [...new Set(menuItems.map((item) => item.category))];

        // Add an "All" category option
        categoriesDropdown.append(`
        <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterMenucat('')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
      `);

        // Loop through the unique categories and add them to the dropdown
        categories.forEach((category) => {
          categoriesDropdown.append(`
          <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterMenucat('${category}')">${category}</a></li>
        `);
        });
      }

      function renderMenuByCategory(filteredItems = menuItems) {
        const isMobile = window.innerWidth <= 768; // Check if it's mobile
        const viewType = isMobile ? "list" : "grid";

        console.log(viewType);
        const menuContainer = $("#menu-grid-container");
        menuContainer.empty();

        const groupedByCategory = filteredItems.reduce((acc, item) => {
          acc[item.category] = acc[item.category] || [];
          acc[item.category].push(item);
          return acc;
        }, {});

        for (const category in groupedByCategory) {
          groupedByCategory[category].sort((a, b) => a.price - b.price);
        }

        Object.keys(groupedByCategory).forEach((category) => {
          const categoryContainer = $("<div>").addClass("mb-4");
          const categoryTitle = $("<h3>")
            .addClass("text-danger font-weight-bold mb-3")
            .text(category);
          categoryContainer.append(categoryTitle);

          const gridContainer = $("<div>").addClass("row");

          const sortedItems = groupedByCategory[category].sort(
            (a, b) => a.price - b.price
          );

          groupedByCategory[category].forEach((item) => {
            if (viewType === "list") {
              // List View Item
              const listItem = $("<div>").addClass("list-view-item");
              listItem.html(`
              <img src="${item.image_url}" alt="${item.name}" />
              <div class="item-details">
                <h5>${item.name}</h5>
                <p>‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price} ‡∏ö‡∏≤‡∏ó</p>
                <label for="quantity-input-${item.id}">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                <input
                  type="number"
                  id="quantity-input-${item.id}"
                  class="form-control"
                  value="1"
                  min="1"
                  style="max-width: 100px;"
                />
              </div>
              <div class="item-actions">
                <button class="btn btn-warning" onclick="addToCart(${item.id}, parseInt($('#quantity-input-${item.id}').val(), 10))">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                <button class="btn btn-outline-secondary" onclick="showProductPopup(${item.id})">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              </div>
            `);
              categoryContainer.append(listItem);
            } else {
              // Grid View Item
              const cardDiv = $("<div>").addClass(
                "col-md-4 col-sm-6 col-12 mb-4"
              );
              cardDiv.html(`
            <div class="card">
              <img src="${item.image_url}" class="card-img-top" alt="${item.name}">
              <div class="card-body">
                <h5 class="card-title">${item.name}</h5>
                <p class="card-text">‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price} ‡∏ö‡∏≤‡∏ó</p>
                <div class="form-group">
                  <label for="quantity-input-${item.id}">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                  <input
                    type="number"
                    id="quantity-input-${item.id}"
                    class="form-control"
                    value="1"
                    min="1"
                  />
                </div>
                <button class="btn btn-warning btn-block" onclick="addToCart(${item.id}, parseInt($('#quantity-input-${item.id}').val(), 10))">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                <button class="btn btn-outline-secondary btn-block" onclick="showProductPopup(${item.id})">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              </div>
            </div>
          `);
              gridContainer.append(cardDiv);
            }
          });
          if (viewType === "grid") {
            categoryContainer.append(gridContainer);
          }
          menuContainer.append(categoryContainer);
        });
      }

      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCart ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      function addToCart(itemId, quantity = 1) {
        const item = menuItems.find((menuItem) => menuItem.id === itemId);
        if (!item) return;

        const existingItem = cart.find((cartItem) => cartItem.id === itemId);
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({ ...item, quantity: quantity });
        }

        updateCart();
        showAddToCartToast(); // Show toast when item is added
      }

      // Update cart function
      function updateCart() {
        localStorage.setItem("cart", JSON.stringify(cart));

        // Calculate total quantity of items in cart
        const totalQuantity = cart.reduce(
          (acc, item) => acc + item.quantity,
          0
        );
        $("#cart-count").text(totalQuantity);

        renderCart();
      }

      // Render cart function
      function renderCart() {
        const cartItemsDiv = $("#cart-items");
        const totalPriceDiv = $("#total-price");

        cartItemsDiv.empty();
        let totalPrice = 0;

        cart.forEach((item) => {
          const cartItemDiv = $("<div>").addClass("cart-item");
          cartItemDiv.html(`
                <span>${item.name}</span>
                <div class="quantity-buttons">
                  <button class="btn btn-sm btn-danger" onclick="changeQuantity(${item.id}, -1)">-</button>
                  <span>${item.quantity}</span>
                  <button class="btn btn-sm btn-success" onclick="changeQuantity(${item.id}, 1)">+</button>
                  <button class="btn btn-sm btn-danger" onclick="removeItem(${item.id})">üóëÔ∏è</button>
                </div>
              `);
          cartItemsDiv.append(cartItemDiv);
          totalPrice += item.price * item.quantity;
        });

        totalPriceDiv.text(`‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalPrice} ‡∏ö‡∏≤‡∏ó`);
      }

      // Change quantity function
      function changeQuantity(itemId, change) {
        const item = cart.find((cartItem) => cartItem.id === itemId);
        if (!item) return;

        item.quantity += change;
        if (item.quantity <= 0) {
          cart = cart.filter((cartItem) => cartItem.id !== itemId);
        }
        updateCart();
      }

      // Remove item function
      function removeItem(itemId) {
        cart = cart.filter((cartItem) => cartItem.id !== itemId);
        updateCart();
        showRemoveFromCartToast(); // Show toast when item is removed
      }

      // Checkout function
      function checkout() {
        // console.log(cart_send);
        if (cart.length === 0) {
          alert("‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢");
          toggleCartPopup();
        } else {
          alert("‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß!");
          console.log(cart);
          var time_ = new Date().toISOString();

          let cart_send = {
            table_id: "{{ table_id }}",
            time: time_,
          };
          for (menu of cart) {
            cart_send[menu["id"]] = menu["quantity"];
          }

          $.post("/orders/create", cart_send, function (data) {
            cart = [];
            updateCart();
          });

          toggleCartPopup();
        }
      }

      // Clear cart function
      function clearcart() {
        cart = [];
        updateCart();
        showRemoveallFromCartToast(); // Show toast when all items are removed
      }

      // Toggle search popup function
      function toggleSearchPopup() {
        $("#search-bar-bottom").css("display", function (i, v) {
          return v === "none" ? "flex" : "none";
        });
        $("#search-input-bottom").focus();
      }

      // Toggle cart popup function
      function toggleCartPopup() {
        $("#cart-popup").toggleClass("show");
        $("#cart-backdrop").toggle(); // Show or hide the backdrop
      }

      // Toggle categories navigation function
      function toggleCategoriesNav() {
        $("#categories-nav").toggle();
      }

      function filterMenucat(category) {
        const filteredItems = category
          ? menuItems.filter((item) => item.category === category)
          : menuItems; // Show all if "All" is selected
        renderMenuByCategory(filteredItems);
      }

      // Show product popup function
      function showProductPopup(productId) {
        const product = menuItems.find((item) => item.id === productId);
        if (!product) return;

        // Display product details in the popup
        $("#product-image").attr("src", product.image_url);
        $("#product-name").text(product.name);
        $("#product-description").text(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${product.name}`);
        $("#product-price").text(`‡∏£‡∏≤‡∏Ñ‡∏≤: ${product.price} ‡∏ö‡∏≤‡∏ó`);
        $("#add-from-popup").data("product-id", productId);

        // Open the popup
        $("#product-popup").addClass("show");
      }

      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCartFromPopup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å input
      function addToCartFromPopup() {
        const productId = $("#add-from-popup").data("product-id");
        const quantity = parseInt($("#quantity-input").val(), 10);

        if (quantity > 0) {
          addToCart(productId, quantity);
          // closeProductPopup();
          showAddToCartToast(); // Show toast here as well
        } else {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
        }
      }

      // Close product popup function
      function closeProductPopup() {
        $("#product-popup").removeClass("show");
      }
      // Function to show toast notification
      function showAddToCartToast() {
        $("#cart-toast").toast("show");
      }
      // Function to show toast notification when an item is removed from the cart
      function showRemoveFromCartToast() {
        $("#remove-toast").toast("show");
      }
      // Function to show toast notification when an item is removed from the cart
      function showRemoveallFromCartToast() {
        $("#remove-all-toast").toast("show");
      }
      $(window).resize(() => {
        renderMenuByCategory(menuItems);
      });

      // Initial render
      // renderMenuByCategory(menuItems);
    </script>
    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
  </body>
</html>
