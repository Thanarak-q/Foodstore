<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/Admin.css') }}"
    />
    {% block extra_css %}{% endblock %}
  </head>

  <body>
    <nav
      class="navbar is-dark"
      style="height: 2.5rem"
      role="navigation"
      aria-label="main navigation"
    >
      <div class="navbar-brand">
        <a class="navbar-item" href="#" id="title_"
          ><strong
            >{{current_user.firstname}} {{current_user.lastname}}</strong
          ></a
        >
        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarAdmin"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div id="navbarAdmin" class="navbar-menu">
        <div class="navbar-end">
          <div class="navbar-item" id="notificationIcon">
            <span class="icon"><i class="fas fa-bell"></i></span>
            <span class="notification-count">0</span>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link">
              <i class="fas fa-user"></i>&nbsp; {{ current_user.role }}
            </a>
            <div class="navbar-dropdown is-right">
              <a class="navbar-item" href="/profile">
                <i class="fas fa-id-badge"></i>&nbsp; Profile
              </a>
              <a class="navbar-item" href="/logout">
                <i class="fas fa-sign-out-alt"></i>&nbsp; Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="notification-sidebar" id="notificationSidebar">
      <div class="notification-header">
        <h3>การแจ้งเตือน</h3>
        <button class="delete" id="closeNotificationSidebar"></button>
      </div>
      <div class="notification-content" id="notifications">
        <!-- Notifications will be loaded here -->
      </div>
    </div>

    <div class="columns is-gapless">
      <div class="column is-2 sidebar" id="sidebar-content">
        <aside class="menu">
          <ul class="menu-list">
            <li>
              <a
                href="{{ url_for('dashboard') }}"
                class="{% if request.endpoint == 'dashboard' %}is-active{% endif %}"
              >
                <i class="fas fa-tachometer-alt"></i>&nbsp; Dashboard
              </a>
            </li>
            <li>
              <a class="menu-label" id="management-label">
                <i class="fas fa-cogs"></i>&nbsp; Management
              </a>
              <ul class="submenu">
                <li>
                  <a
                    href="{{ url_for('table_creates') }}"
                    class="{% if request.endpoint == 'table_list' %}is-active{% endif %}"
                  >
                    <i class="fas fa-table"></i>&nbsp; Table Management
                  </a>
                </li>
                <li>
                  <a
                    href="{{ url_for('menu_list') }}"
                    class="{% if request.endpoint == 'menu_list' %}is-active{% endif %}"
                  >
                    <i class="fas fa-utensils"></i>&nbsp; Menu Management
                  </a>
                </li>
                <li>
                  <a
                    href="{{ url_for('em_list') }}"
                    class="{% if request.endpoint == 'em_list' %}is-active{% endif %}"
                  >
                    <i class="fas fa-users"></i>&nbsp; Employee Management
                  </a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="{{ url_for('orders') }}"
                class="{% if request.endpoint == 'order' %}is-active{% endif %}"
              >
                <i class="fas fa-shopping-cart"></i>&nbsp; Order
              </a>
            </li>
            <li>
              <a
                href="{{ url_for('review_list') }}"
                class="{% if request.endpoint == 'review' %}is-active{% endif %}"
              >
                <i class="fas fa-star"></i>&nbsp; Review
              </a>
            </li>
            <li>
              <a
                href="{{ url_for('menu_list') }}"
                class="{% if request.endpoint == 'reservations' %}is-active{% endif %}"
              >
                <i class="fas fa-calendar-check"></i>&nbsp; Reservations
              </a>
            </li>
            <li>
              <a
                href="{{ url_for('menu_list') }}"
                class="{% if request.endpoint == 'customers' %}is-active{% endif %}"
              >
                <i class="fas fa-user-friends"></i>&nbsp; Customers
              </a>
            </li>
            <li>
              <a
                href="{{ url_for('report') }}"
                class="{% if request.endpoint == 'reports' %}is-active{% endif %}"
              >
                <i class="fas fa-chart-line"></i>&nbsp; Reports
              </a>
            </li>
            <li>
              <a
                href="{{ url_for('setting') }}"
                class="{% if request.endpoint == 'settings' %}is-active{% endif %}"
              >
                <i class="fas fa-cog"></i>&nbsp; Settings
              </a>
            </li>
          </ul>
        </aside>
      </div>

      <div class="column main-content is-fullheight is-fullwidth">
        <div class="card-content">{% block content %}{% endblock %}</div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const burger = document.querySelector(".navbar-burger");
        const menu = document.querySelector("#navbarAdmin");

        burger.addEventListener("click", () => {
          burger.classList.toggle("is-active");
          menu.classList.toggle("is-active");
        });

        const menuLabels = document.querySelectorAll(".menu-label");
        menuLabels.forEach((label) => {
          label.addEventListener("click", () => {
            label.classList.toggle("is-active");
            const submenu = label.nextElementSibling;
            submenu.style.display =
              submenu.style.display === "block" ? "none" : "block";
          });
        });

        const notificationIcon = document.getElementById("notificationIcon");
        const notificationSidebar = document.getElementById(
          "notificationSidebar"
        );
        const closeNotificationSidebar = document.getElementById(
          "closeNotificationSidebar"
        );

        notificationIcon.addEventListener("click", () => {
          notificationSidebar.classList.toggle("open");
        });

        closeNotificationSidebar.addEventListener("click", () => {
          notificationSidebar.classList.remove("open");
        });

        document.addEventListener("click", (event) => {
          if (
            !notificationSidebar.contains(event.target) &&
            !notificationIcon.contains(event.target)
          ) {
            notificationSidebar.classList.remove("open");
          }
        });
      });

      function fetchNotifications() {
        fetch("/api/notifications")
          .then((response) => response.json())
          .then((data) => {
            const notificationsDiv = document.getElementById("notifications");
            const notificationCount = document.querySelector(
              ".notification-count"
            );
            notificationsDiv.innerHTML = "";
            notificationCount.textContent = data.length;

            data.forEach((notif) => {
              const notificationItem = document.createElement("div");
              notificationItem.className = `notification ${
                notif.type === "order" ? "is-success" : "is-warning"
              } is-light`;
              notificationItem.innerHTML = `
                      <i class="fas fa-${
                        notif.type === "order" ? "shopping-cart" : "star"
                      }"></i> ${notif.message} - ${new Date(
                notif.created_at
              ).toLocaleTimeString()}
                      <a href="${
                        notif.link
                      }" class="button is-small is-pulled-right" onclick="markAsRead(${
                notif.notification_id
              })">ดูเพิ่มเติม</a>
                      <button class="button is-small is-danger is-pulled-right" onclick="deleteNotification(${
                        notif.notification_id
                      })">ลบ</button>
                  `;
              notificationsDiv.appendChild(notificationItem);
            });

            // Call fetchNotifications again after 10 seconds
            setTimeout(fetchNotifications, 10000);
          })
          .catch((error) => {
            console.error("Error fetching notifications:", error);
            // Retry after 10 seconds even if there's an error
            setTimeout(fetchNotifications, 10000);
          });
      }

      function markAsRead(notificationId) {
        fetch(`/api/notifications/${notificationId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ is_read: true }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Notification marked as read:", data);
            fetchNotifications();
          })
          .catch((error) => {
            console.error("Error marking notification as read:", error);
          });
      }

      function deleteNotification(notificationId) {
        console.log("Deleting notification with ID:", notificationId); 
        fetch(`/api/notifications/${notificationId}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Notification deleted:", data);
            fetchNotifications();
          })
          .catch((error) => {
            console.error("Error deleting notification:", error);
          });
      }

      setInterval(fetchNotifications, 10000);
      fetchNotifications();
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
