{% extends 'Admin_page/base.html' %} {% block content %}
<div class="row">
  <div class="columns is-vcentered">
    <div class="column is-half">
      <div class="field has-addons">
        <div class="control is-expanded">
          <input class="input" type="text" placeholder="Search..." />
        </div>
        <div class="control">
          <button class="button is-info">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </button>
        </div>
      </div>
    </div>
    <div class="column has-text-right">
      <button class="button is-light">
        <span class="icon">
          <i class="fas fa-bell"></i>
        </span>
        <span
          class="tag is-danger is-rounded"
          style="position: absolute; top: -5px; right: -5px"
          >3</span
        >
      </button>
    </div>
  </div>
</div>

<div class="columns is-vcentered is-justify-content-space-between mt-5">
  <div class="column is-3">
    <h1 class="title">Dashboard</h1>
  </div>
  <div class="column">
    <div class="field is-grouped is-grouped-right">
      <div class="control">
        <button class="button is-info" id="toggleFilterButton">
          Filter Period
        </button>
      </div>
    </div>
    <div id="filterContainer" class="is-hidden">
      <div class="field is-grouped is-grouped-right mt-3">
        <div class="control">
          <input type="date" id="startDate" class="input" />
        </div>
        <div class="control">
          <input type="date" id="endDate" class="input" />
        </div>
        <div class="control">
          <div class="select">
            <select id="timeRange">
              <option value="custom">All time</option>
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
              <option value="year">Year</option>
            </select>
          </div>
        </div>
        <div class="control">
          <button class="button is-info" id="filterButton">Filter</button>
        </div>
        <div class="control">
          <button class="button is-light" id="resetButton">Reset</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-5">
  <div class="columns is-multiline is-centered">
    <div class="column is-one-quarter">
      <div class="card has-text-centered">
        <div class="card-content">
          <i class="fas fa-dollar-sign fa-3x"></i>
          <p class="subtitle">Total Sale</p>
          <p id="totalSale" class="title has-text-weight-bold">กำลังคำนวณ...</p>
        </div>
      </div>
    </div>
    <div class="column is-one-quarter">
      <div class="card has-text-centered">
        <div class="card-content">
          <i class="fas fa-shopping-cart fa-3x"></i>
          <p class="subtitle">Total Order</p>
          <p id="totalOrder" class="title has-text-weight-bold">
            กำลังคำนวณ...
          </p>
        </div>
      </div>
    </div>
    <div class="column is-one-quarter">
      <div class="card has-text-centered">
        <div class="card-content">
          <i class="fas fa-chart-line fa-3x"></i>
          <p class="subtitle">Average Order Value</p>
          <p id="avgOrderValue" class="title has-text-weight-bold">
            กำลังคำนวณ...
          </p>
        </div>
      </div>
    </div>
    <div class="column is-one-quarter">
      <div class="card has-text-centered">
        <div class="card-content">
          <i class="fas fa-utensils fa-3x"></i>
          <p class="subtitle">Total Menu Items</p>
          <p id="totalMenuItems" class="title has-text-weight-bold">
            กำลังคำนวณ...
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-5 is-flex is-justify-content-space-between">
  <div class="column is-half">
    <div class="card">
      <div class="card-content">
        <h2 class="subtitle">Revenue by Year</h2>
        <div class="field is-grouped">
          <div class="control is-expanded">
            <select id="yearSelector" multiple="multiple">
              <option value=""></option>
            </select>
          </div>
          <div class="control">
            <button class="button is-info" id="updateChart">
              Update Chart
            </button>
          </div>
        </div>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <div class="column is-half">
    <div class="card">
      <div class="card-content">
        <h2 class="title is-4">เทรนดิ้ง เมนู Top 5</h2>
        <div id="top5Menus" class="content">
          <!-- ข้อมูลเมนู top 5 -->
        </div>
      </div>
    </div>
  </div>
</div>



<div class="row mt-5">
  <div class="column is-full">
    <div id="notifications">
      <!-- Notifications -->
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- ✅ เรียกใช้งาน Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function () {
    // แก้ไข: เพิ่มการสลับแสดง Filter Container
    $("#toggleFilterButton").click(function () {
      $("#filterContainer").toggleClass("is-hidden");
    });

    // ฟังก์ชันที่มีอยู่แล้ว
    fetchTotalSale();
    fetchTotalOrder();
    fetchtotalMenuItems();
    fetchTop5Menus();
  });
</script>

<!-- ฟังก์ชันอื่นๆ คงเดิม -->
<script>
  $(document).ready(function () {
    $("#filterButton").click(function () {
      fetchTotalSale();
      fetchTotalOrder();
    });

    $("#resetButton").click(function () {
      $("#startDate").val("");
      $("#endDate").val("");
      fetchTotalSale();
      fetchTotalOrder();
    });
  });
</script>

<script>
  function fetchTotalSale() {
    const startDate = $("#startDate").val();
    const endDate = $("#endDate").val();

    $.getJSON("/payment/get_all_payment", function (data) {
      let filteredData = data;

      if (startDate && endDate) {
        filteredData = data.filter((payment) => {
          const paymentTime = new Date(payment.payment_time);
          const start = new Date(startDate);
          const end = new Date(endDate);
          return paymentTime >= start && paymentTime <= end;
        });
      }

      const totalSale = filteredData.reduce(
        (acc, pay) => acc + (Number(pay.amount) || 0),
        0
      );
      $("#totalSale").text(`฿ ${totalSale.toLocaleString()}`);
    });
  }
</script>

<script>
  function fetchTotalOrder() {
    const startDate = $("#startDate").val();
    const endDate = $("#endDate").val();

    $.getJSON("/orders/get_all_orders", function (data) {
      let filteredData = data;

      if (startDate && endDate) {
        filteredData = data.filter((order) => {
          const orderTime = new Date(order.order_time);
          const start = new Date(startDate);
          const end = new Date(endDate);
          return orderTime >= start && orderTime <= end;
        });
      }

      const totalOrder = filteredData.length; // นับจำนวนออเดอร์ทั้งหมด
      $("#totalOrder").text(`${totalOrder.toLocaleString()}`);
    });
  }
</script>

<script>
  function fetchtotalMenuItems() {
    $.getJSON("/menus/get_all_menus", function (menuData) {
      const totalMenuItems = menuData.length;
      $("#totalMenuItems").text(totalMenuItems);
    });
  }
</script>

<script>
  $(document).ready(function () {
    $("#timeRange").change(function () {
      const selectedRange = $(this).val();
      const today = new Date();
      let startDate, endDate;

      switch (selectedRange) {
        case "day":
          startDate = new Date(today);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(today);
          endDate.setHours(23, 59, 59, 999);
          break;
        case "week":
          startDate = new Date(today);
          startDate.setDate(today.getDate() - today.getDay());
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(today);
          endDate.setDate(today.getDate() + (6 - today.getDay()));
          endDate.setHours(23, 59, 59, 999);
          break;
        case "month":
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          endDate.setHours(23, 59, 59, 999);
          break;
        case "year":
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = new Date(today.getFullYear(), 11, 31);
          endDate.setHours(23, 59, 59, 999);
          break;
        default:
          startDate = null;
          endDate = null;
          break;
      }

      if (startDate && endDate) {
        $("#startDate").val(startDate.toISOString().split("T")[0]);
        $("#endDate").val(endDate.toISOString().split("T")[0]);
      } else {
        $("#startDate").val("");
        $("#endDate").val("");
      }
    });
  });
</script>

<script>
  function checkMenuPerformance(menuData) {
    const averageSales =
      menuData.reduce((sum, menu) => sum + menu.ordered, 0) / menuData.length;

    menuData.forEach((menu) => {
      if (menu.ordered > averageSales * 1.5) {
        showNotification(`${menu.name} is selling fast!`, "is-success");
      } else if (menu.ordered < averageSales * 0.5) {
        showNotification(`${menu.name} is underperforming`, "is-warning");
      }
    });
  }
</script>

<script>
  function showNotification(message, type) {
    const notification = $(
      `<div class="notification ${type}">
        <button class="delete"></button>
        ${message}
      </div>`
    );

    $("#notifications").append(notification);

    notification.find(".delete").click(function () {
      notification.remove();
    });

    setTimeout(() => notification.remove(), 5000);
  }
</script>
<script>
  let revenueChart;

  function populateYearSelector(data) {
    const years = [
      ...new Set(
        data.map((payment) => new Date(payment.payment_time).getFullYear())
      ),
    ]
      .sort()
      .reverse();

    const $yearSelector = $("#yearSelector");
    const currentYear = new Date().getFullYear();

    years.forEach((year) => {
      const isSelected = year === currentYear ? "selected" : "";
      $yearSelector.append(
        `<option value="${year}" ${isSelected}>${year}</option>`
      );
    });

    $yearSelector.select2({
      placeholder: "Select years to compare",
      allowClear: true,
      width: "100%",
    });

    // Trigger change เพื่อให้กราฟแสดงผลทันทีหลังจาก populate
    $yearSelector.trigger("change");
  }

  function fetchAndDrawRevenueChart() {
    const selectedYears = $("#yearSelector").val() || [];

    $.getJSON("/payment/get_all_payment", function (data) {
      // Populate year selector on first load
      if ($("#yearSelector").children().length === 1) {
        populateYearSelector(data);
      }

      // Prepare monthly revenue data
      const monthlyRevenue = {};
      data.forEach((payment) => {
        const date = new Date(payment.payment_time);
        const year = date.getFullYear();
        const month = date.getMonth();
        const amount = Number(payment.amount) || 0;

        if (!monthlyRevenue[year]) {
          monthlyRevenue[year] = Array(12).fill(0);
        }
        monthlyRevenue[year][month] += amount;
      });

      const ctx = document.getElementById("revenueChart").getContext("2d");
      if (revenueChart) {
        revenueChart.destroy();
      }

      const colors = [
        "rgb(75, 192, 192)",
        "rgb(255, 99, 132)",
        "rgb(54, 162, 235)",
        "rgb(255, 206, 86)",
        "rgb(153, 102, 255)",
        "rgb(255, 159, 64)",
        "rgb(199, 199, 199)",
        "rgb(83, 83, 83)",
      ];

      const datasets = selectedYears.map((year, index) => ({
        label: `Revenue ${year}`,
        data: monthlyRevenue[year] || Array(12).fill(0),
        borderColor: colors[index % colors.length],
        tension: 0.1,
      }));

      revenueChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ],
          datasets: datasets,
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Revenue (฿)",
              },
              ticks: {
                callback: function (value) {
                  return "฿" + value.toLocaleString();
                },
              },
            },
            x: {
              title: {
                display: true,
                text: "Month",
              },
            },
          },
          plugins: {
            legend: {
              position: "top",
            },
            title: {
              display: true,
              text: "Monthly Revenue Comparison",
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  label += "฿" + context.parsed.y.toLocaleString();
                  return label;
                },
              },
            },
          },
        },
      });
    }).fail(function (jqXHR, textStatus, errorThrown) {
      console.error("Error fetching data:", textStatus, errorThrown);
    });
  }

  $(document).ready(function () {
    // ตรวจสอบว่า canvas พร้อมใช้งานก่อนเรียก
    if (document.getElementById("revenueChart")) {
      fetchAndDrawRevenueChart();
    }

    $("#yearSelector").on("change", function () {
      fetchAndDrawRevenueChart();
    });

    $("#updateChart").click(function () {
      fetchAndDrawRevenueChart();
    });
  });
</script>
<script>
  function fetchTop5Menus() {
    $.getJSON("/menus/get_all_menus", function (data) {
      const sortedMenus = data.sort((a, b) => b.ordered - a.ordered);
      const top5Menus = sortedMenus.slice(0, 5);

      let htmlContent = '';
      top5Menus.forEach((menu, index) => {
        htmlContent += `
          <div class="media">
            <div class="media-left">
              <figure class="image is-128x128">
                <img src="${menu.image_url}" alt="${menu.name}" style="width: 100%; height: auto;">
              </figure>
            </div>
            <div class="media-content">
              <p class="title is-4 has-text-weight-bold">${index + 1}. ${menu.name}</p>
              <p class="subtitle is-6 has-text-grey-dark">จำนวนการสั่ง: <strong>${menu.ordered} ครั้ง</strong></p>
              <p class="subtitle is-6 has-text-grey-dark">ราคา: <strong>฿${menu.price}</strong></p>
            </div>
          </div>
        `;
      });

      $("#top5Menus").html(htmlContent);
    });
  }
</script>
{% endblock %}
