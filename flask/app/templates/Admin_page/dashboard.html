{% extends 'Admin_page/base.html' %}

{% block content %}
<div class="columns is-multiline">
  <!-- Total Sale Card -->
  <div class="column is-full-mobile is-half-tablet is-one-third-desktop">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title is-size-5-mobile is-size-4-tablet has-text-centered">
          Total Sale
        </p>
      </header>
      <div class="card-content">
        <article class="media is-align-items-center">
          <figure class="media-left">
            <p class="image is-64x64">
              <img src="/static/dashboard/total_revenue.png" alt="Sale Icon">
            </p>
          </figure>
          <div class="media-content has-text-centered">
            <p id="totalSale" class="subtitle is-size-6-mobile is-size-5-tablet">
              กำลังคำนวณ...
            </p>
          </div>
        </article>
      </div>
    </div>
  </div>

  <!-- Total Order Card -->
  <div class="column is-full-mobile is-half-tablet is-one-third-desktop">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title is-size-5-mobile is-size-4-tablet has-text-centered">
          Total Order
        </p>
      </header>
      <div class="card-content">
        <article class="media is-align-items-center">
          <figure class="media-left">
            <p class="image is-64x64">
              <img src="/static/dashboard/total_order.png" alt="Sale Icon">
            </p>
          </figure>
          <div class="media-content has-text-centered">
            <p id="totalOrder" class="subtitle is-size-6-mobile is-size-5-tablet">
              กำลังคำนวณ...
            </p>
          </div>
        </article>
      </div>
    </div>
  </div>

  <!-- Average Order Value Card -->
  <div class="column is-full-mobile is-half-tablet is-one-third-desktop">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Average Order Value</p>
      </header>
      <div class="card-content">
        <p id="avgOrderValue" class="title">กำลังคำนวณ...</p>
      </div>
    </div>
  </div>
</div>

<div class="columns is-multiline">
  <!-- Top 5 Menus Card -->
  <div class="column is-full-tablet is-half-desktop">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title is-size-5-mobile is-size-4-tablet">เทรนดิ้ง เมนู top 5</p>
      </header>
      <div class="card-content">
        <div id="top5Menus" class="content">
          <!-- ข้อมูลเมนู top 5 จะถูกแสดงที่นี่ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue Overview Card -->
  <div class="column is-full-tablet is-half-desktop">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title is-size-5-mobile is-size-4-tablet">Revenue Overview</p>
        <div class="select is-fullwidth-mobile is-medium-tablet">
          <select id="timeFilter">
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
            <option value="yearly">รายปี</option>
          </select>
        </div>
      </header>
      <div class="card-content">
        <div class="canvas-container">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="columns is-multiline">
  <!-- Total Menu Items Card -->
  <div class="column is-full-mobile is-half-tablet is-one-third-desktop">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Total Menu Items</p>
      </header>
      <div class="card-content">
        <p id="totalMenuItems" class="title">กำลังคำนวณ...</p>
      </div>
    </div>
  </div>

  <!-- Top Category Card -->
  <div class="column is-full-mobile is-half-tablet is-one-third-desktop">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Top Category</p>
      </header>
      <div class="card-content">
        <p id="topCategory" class="title">กำลังคำนวณ...</p>
      </div>
    </div>
  </div>

  <!-- Sales by Category Card -->
  <div class="column is-full">
    <div class="card">
      <header class="card-header">
        <p class="card-header-title">Sales by Category</p>
      </header>
      <div class="card-content">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ✅ เรียกใช้งาน Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  $(document).ready(function () {
    // Fetch and display total sale and total order
    $.getJSON("/menus/get_all_menus", function (data) {
      const totalSale = data.reduce((acc, menu) => acc + (menu.ordered * menu.price), 0);
      const totalOrder = data.reduce((acc, menu) => acc + menu.ordered, 0);

      $("#totalSale").text(`฿ ${totalSale.toLocaleString()}`);
      $("#totalOrder").text(`${totalOrder.toLocaleString()}`);
    });

    // Fetch and display top 5 menus
    $.getJSON("/menus/get_all_menus", function (data) {
      const sortedMenus = data.sort((a, b) => b.ordered - a.ordered);
      const top5Menus = sortedMenus.slice(0, 5);

      let htmlContent = '';
      top5Menus.forEach((menu, index) => {
        htmlContent += `
          <div class="media">
            <div class="media-left">
              <figure class="image is-64x64">
                <img src="${menu.image_url}" alt="${menu.name}">
              </figure>
            </div>
            <div class="media-content">
              <p class="title is-4 has-text-weight-bold">${index + 1}. ${menu.name}</p>
              <p class="subtitle is-6 has-text-grey-dark">จำนวนการสั่ง: <strong>${menu.ordered} ครั้ง</strong></p>
              <p class="subtitle is-6 has-text-grey-dark">ราคา: <strong>฿${menu.price}</strong></p>
            </div>
          </div>
        `;
      });

      $("#top5Menus").html(htmlContent);
    });

    // Fetch and display revenue chart
    let revenueChart;
    $.getJSON("/payment/get_all_payment", function (data) {
      updateChart(data, 'monthly');

      $('#timeFilter').change(function () {
        const selectedFilter = $(this).val();
        updateChart(data, selectedFilter);
      });
    });

    function updateChart(data, timeFilter) {
      const groupedData = groupDataByTime(data, timeFilter);
      const labels = Object.keys(groupedData).sort();
      const revenueData = labels.map(label => groupedData[label]);

      const ctx = document.getElementById('revenueChart').getContext('2d');

      if (revenueChart) {
        revenueChart.destroy();
      }

      revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `รายได้${getTimeLabel(timeFilter)}`,
            data: revenueData,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function groupDataByTime(data, timeFilter) {
      const groupedData = {};

      data.forEach(payment => {
        const date = new Date(payment.payment_time);
        let key;

        if (timeFilter === 'weekly') {
          const weekNumber = getWeekNumber(date);
          key = `${date.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
        } else if (timeFilter === 'monthly') {
          key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        } else if (timeFilter === 'yearly') {
          key = `${date.getFullYear()}`;
        }

        if (!groupedData[key]) {
          groupedData[key] = 0;
        }
        groupedData[key] += payment.amount;
      });

      return groupedData;
    }

    function getWeekNumber(date) {
      const startOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - startOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
    }

    function getTimeLabel(timeFilter) {
      switch (timeFilter) {
        case 'weekly':
          return 'รายสัปดาห์';
        case 'monthly':
          return 'รายเดือน';
        case 'yearly':
          return 'รายปี';
        default:
          return '';
      }
    }

    // Fetch and display average order value, total menu items, and top category
    $.getJSON("/menus/get_all_menus", function(menuData) {
      const totalSale = menuData.reduce((acc, menu) => acc + (menu.ordered * menu.price), 0);
      const totalOrder = menuData.reduce((acc, menu) => acc + menu.ordered, 0);
      const avgOrderValue = totalSale / totalOrder;
      const totalMenuItems = menuData.length;

      const categorySales = {};
      menuData.forEach(menu => {
        if (!categorySales[menu.category]) {
          categorySales[menu.category] = 0;
        }
        categorySales[menu.category] += menu.ordered * menu.price;
      });
      const topCategory = Object.keys(categorySales).reduce((a, b) => 
        categorySales[a] > categorySales[b] ? a : b
      );

      $("#avgOrderValue").text(`฿${avgOrderValue.toFixed(2)}`);
      $("#totalMenuItems").text(totalMenuItems);
      $("#topCategory").text(topCategory);
    });

    // Fetch and display sales by category chart
    $.getJSON("/menus/get_all_menus", function(menuData) {
      const categoryData = menuData.reduce((acc, menu) => {
        if (!acc[menu.category]) {
          acc[menu.category] = 0;
        }
        acc[menu.category] += menu.ordered * menu.price;
        return acc;
      }, {});

      const ctx = document.getElementById('categoryChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(categoryData),
          datasets: [{
            data: Object.values(categoryData),
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
              '#9966FF', '#FF9F40', '#C9CBCF'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            }
          }
        }
      });
    });

    // Check menu performance and show notifications
    function checkMenuPerformance(menuData) {
      const averageSales = menuData.reduce((sum, menu) => sum + menu.ordered, 0) / menuData.length;
      
      menuData.forEach(menu => {
        if (menu.ordered > averageSales * 1.5) {
          showNotification(`${menu.name} is selling fast!`, 'is-success');
        } else if (menu.ordered < averageSales * 0.5) {
          showNotification(`${menu.name} is underperforming`, 'is-warning');
        }
      });
    }
    
    function showNotification(message, type) {
      const notification = $(`
        <div class="notification ${type}">
          <button class="delete"></button>
          ${message}
        </div>
      `);
      
      $('.columns').before(notification);
      
      notification.find('.delete').click(function() {
        notification.remove();
      });
      
      setTimeout(() => notification.remove(), 5000);
    }
  });
</script>
{% endblock %}