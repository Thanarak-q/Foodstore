{% extends 'Admin_page/base.html' %}

{% block extra_css %}
<style>
  .bootstrap-table .pagination {
    margin: 5rem;
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .bootstrap-table .page-item {
    display: inline-block;
  }

  .bootstrap-table .page-link {
    padding: 0.5rem 1rem;
    border: 1px solid #dbdbdb;
    background-color: #ffffff;
    color: #363636;
    border-radius: 4px;
    font-size: 1rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .bootstrap-table .page-item.active .page-link {
    background-color: #3273dc;
    border-color: #3273dc;
    color: #ffffff;
  }

  .bootstrap-table .page-item.disabled .page-link {
    background-color: #f5f5f5;
    color: #7a7a7a;
    cursor: not-allowed;
    opacity: 0.65;
  }

  .bootstrap-table .page-link:hover:not(.active) {
    background-color: #f5f5f5;
    color: #3273dc;
  }

  .bootstrap-table .btn-page-size {
    padding: 0.5rem 1rem;
    border: 1px solid #dbdbdb;
    background-color: #ffffff;
    color: #363636;
    border-radius: 4px;
  }

  .bootstrap-table .pagination-detail {
    display: none;
  }

  .fixed-table-toolbar .search-input {
    border: 2px solid #dbdbdb;
    border-radius: 25px;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 300px;
  }

  .fixed-table-toolbar .search-input:focus {
    border-color: #3273dc;
    box-shadow: 0 0 5px rgba(50, 115, 220, 0.3);
    outline: none;
  }

  .fixed-table-toolbar {
    margin: 1.5rem 0;
    display: flex;
    justify-content: right;
  }

  /* Center table items */
  .table td,
  .table th {
    text-align: center;
    vertical-align: middle;
  }

  /* Style for menu list in cells */
  .table td[data-field="menu_list"] {
    white-space: pre-wrap;
  }

  /* Style for status tags */
  .table td .tag {
    display: inline-block;
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block content %}
<br>
<div id="header" class="container">
  <h1 class="title has-text-black">Order Management</h1>
</div>
<br>

<div id="add-edit" class="container" hidden="hidden">
  <div id="add-edit" class="container">
    <h2 id="add-edit-caption" class="subtitle has-text-black">
      Add/Edit an Order:
    </h2>
    <form id="addOrderForm" class="box">
      <div class="field">
        <label class="label has-text-black" for="order_id">Order ID</label>
        <div class="control">
          <input class="input" type="text" id="order_id" name="order_id" placeholder="Order ID.." required />
        </div>
      </div>
      <div class="field">
        <label class="label has-text-black" for="table_id">Table ID</label>
        <div class="control">
          <input class="input" type="number" id="table_id" name="table_id" placeholder="Table ID.." required />
        </div>
      </div>
      <div class="field">
        <label class="label has-text-black" for="status">Status</label>
        <div class="control">
          <div class="select">
            <select id="status" name="status" required>
              <option value="Ready">Ready</option>
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
              <option value="Preparing">Preparing</option>
            </select>
          </div>
        </div>
      </div>
      <div class="field">
        <label class="label has-text-black" for="total_price">Total Price</label>
        <div class="control">
          <input class="input" type="number" id="total_price" name="total_price" placeholder="Total Price.." required
            step="0.01" />
        </div>
      </div>
      <div class="field">
        <label class="label has-text-black" for="menu_list">Menu List (JSON)</label>
        <div class="control">
          <textarea class="textarea" id="menu_list" name="menu_list" placeholder='{"menu_id": quantity, ...}'
            required></textarea>
        </div>
      </div>
      <div class="field is-grouped">
        <div class="control">
          <input class="button is-link" type="submit" name="submit" value="Submit" />
        </div>
        <div class="control">
          <button id="clear_form" class="button is-light" type="button">
            Clear
          </button>
        </div>
        <div class="control">
          <button id="cancel_form" class="button is-light" type="button">
            Cancel
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="table_display" class="container">
  <button id="add_order" class="button is-primary is-size-4" type="button">
    <p class="has-text-weight-bold">Create Order</p>
  </button>
  <br>
  <br>

  <div class="table-container">
    <table class="table is-striped is-bordered is-hoverable is-fullwidth" id="order-table" data-sort-name="order_id">
      <thead>
        <tr>
          <th data-field="order_id" data-sortable="true">
            <span class="has-text-black">Order ID</span>
          </th>
          <th data-field="table_id" data-sortable="true">
            <span class="has-text-black">Table ID</span>
          </th>
          <th data-field="status" data-sortable="true">
            <span class="has-text-black">Status</span>
          </th>
          <th data-field="total_price" data-sortable="true">
            <span class="has-text-black">Total Price</span>
          </th>
          <th data-field="menu_list" data-sortable="false">
            <span class="has-text-black">Menu List</span>
          </th>
          <th data-field="operation" data-formatter="actionFormatter" data-events="operateEvents">
            <span class="has-text-black">Edit/Delete</span>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function populate_table(table_data, menuMap) {
    $("#order-table").bootstrapTable({
      data: table_data,
      columns: [
        { field: 'order_id', title: 'Order ID', sortable: true },
        { field: 'table_id', title: 'Table ID', sortable: true },
        { field: 'status', title: 'Status', sortable: true, formatter: statusFormatter },
        { field: 'total_price', title: 'Total Price', sortable: true },
        { field: 'menu_list', title: 'Menu List', sortable: false, formatter: function (value) { return menuListFormatter(value, menuMap); } },
        { field: 'operation', title: 'Edit/Delete', formatter: actionFormatter, events: operateEvents }
      ],
      loadingTemplate: function () {
        return "";
      },
      pagination: true,
      pageSize: 5,
      paginationDetailHAlign: "hidden",
      showPaginationSwitch: false,
      showPageList: false,
      paginationFirstText: '<i class="fas fa-angle-double-left"></i>',
      paginationLastText: '<i class="fas fa-angle-double-right"></i>'
    });
  }

  $(document).ready(function () {
    let menuMap = {};

    // Load menu data from 2nd DB first
    $.getJSON("/menus/get_all_menus", function (menus) {
      menus.forEach((menu) => {
        menuMap[menu.id] = menu.name; // Map menu.id to menu.name
      });
      // Load order data after menu data is loaded
      $.getJSON("/orders/get_all_orders", function (orderData) {
        populate_table(orderData, menuMap); // Pass menuMap to populate_table
      }).fail(function (jqXHR, textStatus, error) {
        console.error("Failed to load order data:", textStatus, error);
        populate_table([], menuMap); // Load empty table if order data fails
      });
    }).fail(function (jqXHR, textStatus, error) {
      console.error("Failed to load menu data:", textStatus, error);
      // Load order data even if menu data fails
      $.getJSON("/orders/get_all_orders", function (orderData) {
        populate_table(orderData, {}); // Use empty menuMap if menu data fails
      }).fail(function (jqXHR, textStatus, error) {
        console.error("Failed to load order data:", textStatus, error);
        populate_table([], {}); // Load empty table if both fail
      });
    });
  });

  function refresh_table(table_data) {
    $("#order-table").bootstrapTable("load", table_data);
  }

  function menuListFormatter(value, menuMap) {
    let menuList = '';
    for (let menuId in value) {
      const menuName = menuMap[menuId] || `Menu ${menuId} (Unknown)`; // Use menu name or menuId if not found
      menuList += `${menuName}: ${value[menuId]}<br>`;
    }
    return menuList || 'No menus';
  }

  function statusFormatter(value) {
    if (value === "Ready") {
      return '<span class="tag is-success is-size-5">Ready</span>';
    } else if (value === "Preparing") {
      return '<span class="tag is-warning is-size-5">Preparing</span>';
    } else if (value === "Pending") {
      return '<span class="tag is-info is-size-5">Pending</span>';
    } else if (value === "Completed") {
      return '<span class="tag is-primary is-size-5">Completed</span>';
    }
    return '<span class="tag is-danger is-size-5">' + value + '</span>';
  }

  $("#addOrderForm").submit(function (event) {
    event.preventDefault();

    var formData = {
      order_id: $("#order_id").val().trim(),
      table_id: parseInt($("#table_id").val().trim()),
      status: $("#status").val(),
      total_price: parseFloat($("#total_price").val().trim()),
      menu_list: JSON.parse($("#menu_list").val().trim())
    };

    // Validate form data
    if (!formData.order_id || !formData.table_id || !formData.status || !formData.total_price || !formData.menu_list) {
      alert("Please fill in all required fields.");
      return;
    }

    if (typeof formData.menu_list !== 'object' || Array.isArray(formData.menu_list)) {
      alert("Invalid menu list format. Please enter a valid JSON object (e.g., {\"10\": 4, \"13\": 4}).");
      return;
    }

    var $form = $(this);
    var url = "/orders";
    var method = "POST"; // Default to POST for adding new orders

    // Check if editing an existing order
    if ($("#is_edit").length && $("#is_edit").val() === "true") {
      url = `/orders/update`;
      method = "PUT"; // Use PUT for updating existing orders
    }

    $.ajax({
      url: url,
      method: method,
      data: JSON.stringify(formData),
      contentType: "application/json",
      success: function (table_data) {
        try {
          if (!Array.isArray(table_data) && typeof table_data !== "object") {
            throw new Error("Invalid response format from server");
          }
          refresh_table(table_data);
          clearForm();
          toggleView();
          alert((method === "POST" ? "Order created" : "Order updated") + " successfully!");
        } catch (error) {
          console.error("Error processing response:", error);
          alert("An error occurred while processing the response. Please try again or contact support.");
        }
      },
      error: function (jqXHR, textStatus, errorThrown) {
        let errorMessage = `Failed to ${method === "POST" ? "create" : "update"} order: ${textStatus}`;
        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
          errorMessage += ` - ${jqXHR.responseJSON.message}`;
        } else if (jqXHR.status === 401) {
          errorMessage += " - Unauthorized. Please log in again.";
        } else if (jqXHR.status === 403) {
          errorMessage += " - Forbidden. You don't have permission.";
        } else if (jqXHR.status === 500) {
          errorMessage += " - Server error. Please try again later.";
        } else {
          errorMessage += ` - ${errorThrown || "Unknown error"}`;
        }
        console.error(errorMessage, jqXHR);
        alert(errorMessage);
      }
    });
  });

  function clearForm() {
    $("#addOrderForm")[0].reset();
    if ($("#is_edit").length) {
      $("#is_edit").val("false"); // Reset to add mode
    }
  }

  function toggleView() {
    if ($("#table_display").attr("hidden")) {
      $("#table_display").removeAttr("hidden");
      $("#add-edit").attr("hidden", "hidden");
    } else {
      $("#table_display").attr("hidden", "hidden");
      $("#add-edit").removeAttr("hidden");
    }
  }

  function actionFormatter(value, row, index) {
    return [
      '<a class="edit" href="javascript:void(0)" title="Edit">',
      "‚úèÔ∏è",
      "</a>  ",
      '<a class="remove" href="javascript:void(0)" title="Remove">',
      "üóëÔ∏è",
      "</a>",
    ].join("");
  }

  window.operateEvents = {
    "click .edit": function (e, value, row, index) {
      prePopulateForm(row);
    },
    "click .remove": function (e, value, row, index) {
      removeItem(row);
    },
  };

  function prePopulateForm(row) {
    $("#addOrderForm")[0].reset();
    $("#order_id").val(row.order_id);
    $("#table_id").val(row.table_id);
    $("#status").val(row.status);
    $("#total_price").val(row.total_price);
    $("#menu_list").val(JSON.stringify(row.menu_list));
    if ($("#is_edit").length) {
      $("#is_edit").val("true"); // Set to edit mode
    }
    toggleView();
  }

  function removeItem(row) {
    if (!confirm("Delete order with ID " + row.order_id + "?")) {
      return false;
    }
    var url = "/orders/delete";
    var formData = { order_id: row.order_id };
    $.post(url, formData, function (table_data) {
      refresh_table(table_data);
      alert("Order with ID " + row.order_id + " has been deleted.");
    }).fail(function (jqXHR, textStatus, error) {
      let errorMessage = `Failed to delete order: ${textStatus}`;
      if (jqXHR.status === 401) {
        errorMessage += " - Unauthorized. Please log in again.";
      } else if (jqXHR.status === 403) {
        errorMessage += " - Forbidden. You don't have permission.";
      } else if (jqXHR.status === 500) {
        errorMessage += " - Server error. Please try again later.";
      } else {
        errorMessage += ` - ${error || "Unknown error"}`;
      }
      console.error(errorMessage, jqXHR);
      alert(errorMessage);
    });
  }

  $("#add_order").click(function () {
    clearForm();
    toggleView();
  });

  $("#clear_form").click(function () {
    clearForm();
  });

  $("#cancel_form").click(function () {
    clearForm();
    toggleView();
  });
</script>
{% endblock %}