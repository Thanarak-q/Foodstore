{% extends 'Admin_page/base.html' %}

{% block extra_css %}
<style>
  .bootstrap-table .pagination {
    margin: 5rem;
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .bootstrap-table .page-item {
    display: inline-block;
  }

  .bootstrap-table .page-link {
    padding: 0.5rem 1rem;
    border: 1px solid #dbdbdb;
    background-color: #ffffff;
    color: #363636;
    border-radius: 4px;
    font-size: 1rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .bootstrap-table .page-item.active .page-link {
    background-color: #3273dc;
    border-color: #3273dc;
    color: #ffffff;
  }

  .bootstrap-table .page-item.disabled .page-link {
    background-color: #f5f5f5;
    color: #7a7a7a;
    cursor: not-allowed;
    opacity: 0.65;
  }

  .bootstrap-table .page-link:hover:not(.active) {
    background-color: #f5f5f5;
    color: #3273dc;
  }

  .bootstrap-table .btn-page-size {
    padding: 0.5rem 1rem;
    border: 1px solid #dbdbdb;
    background-color: #ffffff;
    color: #363636;
    border-radius: 4px;
  }

  .bootstrap-table .pagination-detail {
    display: none;
  }

  .fixed-table-toolbar .search-input {
    border: 2px solid #dbdbdb;
    border-radius: 25px;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 300px;
  }

  .fixed-table-toolbar .search-input:focus {
    border-color: #3273dc;
    box-shadow: 0 0 5px rgba(50, 115, 220, 0.3);
    outline: none;
  }

  .fixed-table-toolbar {
    margin: 1.5rem 0;
    display: flex;
    justify-content: right;
  }

  /* Center table items */
  .table td,
  .table th {
    text-align: center;
    vertical-align: middle;
  }

  /* Style for menu list in cells */
  .table td[data-field="menu_list"] {
    white-space: pre-wrap;
  }

  /* Style for status tags */
  .table td .tag {
    display: inline-block;
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block content %}
<br>
<div id="header" class="container">
  <h1 class="title has-text-black">Order Management</h1>
</div>
<br>

<div id="add-edit" class="container" hidden="hidden">
  <div id="add-edit" class="container">
    <h2 id="add-edit-caption" class="subtitle has-text-black">
      Add/Edit an Order:
    </h2>
    <form id="addOrderForm" class="box">
      <div class="field">
        <label class="label has-text-black" for="order_id">Order ID</label>
        <div class="control">
          <input class="input" type="text" id="order_id" name="order_id" placeholder="Order ID.." required />
        </div>
      </div>
      <div class="field">
        <label class="label has-text-black" for="table_id">Table ID</label>
        <div class="control">
          <div class="select">
            <select id="table_id_" name="table_id_" required>
            </select>

          </div>
          <!-- <input class="input" type="number" id="table_id" name="table_id" placeholder="Table ID.." required /> -->
        </div>
      </div>
      <div class="field">
        <label class="label has-text-black" for="status">Status</label>
        <div class="control">
          <div class="select">
            <select id="status" name="status" required>
              <option value="Ready">Ready</option>
              <option value="Paid">Paid</option>
              <option value="Served">Served</option>
              <option value="Preparing">Preparing</option>
            </select>
          </div>
        </div>
      </div>
      <!-- <div class="field">
          <label class="label has-text-black" for="total_price">Total Price</label>
          <div class="control">
            <input class="input" type="number" id="total_price" name="total_price" placeholder="Total Price.." required
              step="0.01" />
          </div>
        </div> -->
      <!-- <div class="field">
        <label class="label has-text-black" for="menu_list">Menu List</label>
        <div class="control">
          <textarea class="textarea" id="menu_list" name="menu_list" placeholder='{"menu_id": quantity, ...}'
            required></textarea>
        </div>
      </div> -->
      <div class="field">
        <label class="label has-text-black" for="menu_id">Menu ID</label>
        <div class="control" id="menu_id_">
          <!-- <div class="select" id="select_menu">

          </div> -->
          <!-- <input class="input" type="number" id="table_id" name="table_id" placeholder="Table ID.." required /> -->
        </div>
      </div>
      <div class="field is-grouped">
        <div class="control">
          <input class="button is-link" type="submit" name="submit" value="Submit" />
        </div>
        <div class="control">
          <button id="clear_form" class="button is-light" type="button">
            Clear
          </button>
        </div>
        <div class="control">
          <button id="cancel_form" class="button is-light" type="button">
            Cancel
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="table_display" class="container">
  <button id="add_order" class="button is-primary is-size-4" type="button">
    <p class="has-text-weight-bold">Create Order</p>
  </button>
  <br>
  <br>

  <div class="table-container">
    <table class="table is-striped is-bordered is-hoverable is-fullwidth" id="order-table" data-sort-name="order_id">
      <thead>
        <tr>
          <th data-field="order_id" data-sortable="true">
            <span class="has-text-black">Order ID</span>
          </th>
          <th data-field="table_id" data-sortable="true">
            <span class="has-text-black">Table ID</span>
          </th>
          <th data-field="status" data-sortable="true">
            <span class="has-text-black">Status</span>
          </th>
          <th data-field="total_price" data-sortable="true">
            <span class="has-text-black">Total Price</span>
          </th>
          <th data-field="menu_list" data-sortable="false">
            <span class="has-text-black">Menu List</span>
          </th>
          <th data-field="operation" data-formatter="actionFormatter" data-events="operateEvents">
            <span class="has-text-black">Edit/Delete</span>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function populate_table(table_data, menuMap) {
    $("#order-table").bootstrapTable({
      data: table_data,
      columns: [
        { field: 'order_id', title: 'Order ID', sortable: true },
        { field: 'table_id', title: 'Table ID', sortable: true },
        { field: 'status', title: 'Status', sortable: true, formatter: statusFormatter },
        { field: 'total_price', title: 'Total Price', sortable: true },
        { field: 'menu_list', title: 'Menu List', sortable: false, formatter: function (value) { return menuListFormatter(value, menuMap); } },
        { field: 'operation', title: 'Edit/Delete', formatter: actionFormatter, events: operateEvents }
      ],
      loadingTemplate: function () {
        return "";
      },
      pagination: true,
      pageSize: 10,
      paginationDetailHAlign: "hidden",
      showPaginationSwitch: false,
      showPageList: false,
      paginationFirstText: '<i class="fas fa-angle-double-left"></i>',
      paginationLastText: '<i class="fas fa-angle-double-right"></i>'
    });
  }

  var orderlast = 0
  var table_list = []
  var menuMap = {};

  $(document).ready(function () {


    // Load menu data from 2nd DB first
    $.getJSON("/menus/get_all_menus", function (menus) {
      menus.forEach((menu) => {
        menuMap[menu.id] = menu.name; // Map menu.id to menu.name 
      });
      // Load order data after menu data is loaded
      $.getJSON("/orders/get_all_orders", function (orderData) {
        orderlast = orderData[orderData.length - 1].order_id
        // console.log(orderlast)

        populate_table(orderData, menuMap); // Pass menuMap to populate_table
      }).fail(function (jqXHR, textStatus, error) {
        console.error("Failed to load order data:", textStatus, error);
        populate_table([], menuMap); // Load empty table if order data fails
      });
    }).fail(function (jqXHR, textStatus, error) {
      console.error("Failed to load menu data:", textStatus, error);
      // Load order data even if menu data fails
      $.getJSON("/orders/get_all_orders", function (orderData) {
        populate_table(orderData, {}); // Use empty menuMap if menu data fails
      }).fail(function (jqXHR, textStatus, error) {
        console.error("Failed to load order data:", textStatus, error);
        populate_table([], {}); // Load empty table if both fail
      });
    });

    $.getJSON("/table/get_all_table", function (data) {
      for (i of data) {
        table_list.push(i.table_id)
        // console.log(i.table_id)
      }
    })




    // console.log(orderlast)
  });
  // console.log(orderlast)
  function refresh_table(table_data) {
    $("#order-table").bootstrapTable("load", table_data);
  }

  function menuListFormatter(value, menuMap) {
    let menuList = '';
    for (let menuId in value) {
      const menuName = menuMap[menuId] || `Menu ${menuId} (Unknown)`; // Use menu name or menuId if not found
      menuList += `${menuName}: ${value[menuId]}<br>`;
    }
    return menuList || 'No menus';
  }

  function statusFormatter(value) {
    if (value === "Ready") {
      return '<span class="tag is-success is-size-5">Ready</span>';
    } else if (value === "Preparing") {
      return '<span class="tag is-warning is-size-5">Preparing</span>';
    } else if (value === "Paid") {
      return '<span class="tag is-info is-size-5">Paid</span>';
    } else if (value === "Served") {
      return '<span class="tag is-primary is-size-5">Served</span>';
    }
    return '<span class="tag is-danger is-size-5">' + value + '</span>';
  }

  $("#addOrderForm").submit(function (event) {
    event.preventDefault();
    // var form_ = new FormData(this);
    // console.log(form_)
    var time_ = new Date().toISOString();
    var formData = {
      table_id: $('#table_id_').val(),
      time: time_,
    };
    for (let i = 1; i <= 5; i++) {
      let menu_id_send = $(`#menu_id_${i}`).val();
      let quantity_send = $(`#quatity_id_${i}`).val();
      if (menu_id_send == "") {
        continue
      }
      formData[`${menu_id_send}`] = `${quantity_send}`;
    }


    console.log(formData)
    $.post("/orders/create", formData, function (data) {
      console.log("Receieving Data: ", data);
      refresh_table(data);
      clearForm();
      toggleView();
    });
    // var url = "/orders/create";

    // $.ajax({
    //   url: url,
    //   type: "POST",
    //   data: formData,
    //   processData: false,
    //   contentType: false,
    //   success: function (table_data) {
    //     console.log("Receieving Data: ", table_data);
    //     refresh_table(table_data);
    //     clearForm();
    //     toggleView();
    //   },
    //   error: function (xhr, status, error) {
    //     console.error("Error:", error);
    //   },
    // });

  });

  function clearForm() {
    $("#addOrderForm")[0].reset();
  }

  function toggleView() {
    if ($("#table_display").attr("hidden")) {
      $("#table_display").removeAttr("hidden");
      $("#add-edit").attr("hidden", "hidden");
    } else {
      $("#table_display").attr("hidden", "hidden");
      $("#add-edit").removeAttr("hidden");
    }
  }

  function actionFormatter(value, row, index) {
    return [
      '<a class="edit" href="javascript:void(0)" title="Edit">',
      "‚úèÔ∏è",
      "</a>  ",
      '<a class="remove" href="javascript:void(0)" title="Remove">',
      "üóëÔ∏è",
      "</a>",
    ].join("");
  }

  window.operateEvents = {
    "click .edit": function (e, value, row, index) {
      prePopulateForm(row);
    },
    "click .remove": function (e, value, row, index) {
      removeItem(row);
    },
  };

  function prePopulateForm(row) {
    // console.log(row.table_id)
    console.log(row.menu_list)

    $("#addOrderForm")[0].reset();
    $("#order_id").val(row.order_id);
    let table_ = ""
    for (i of table_list) {
      if (i == row.table_id) {
        table_ += `<option value="${i}" id="table_${i}" selected>${i}</option>`
        continue
      }
      table_ += `<option value="${i}" id="table_${i}">${i}</option>`
    }
    $('#table_id_').html(table_);

    $("#status").val(row.status);
    // $("#total_price").val(row.total_price);
    let menu = ""
    for (let num = 1; num <= 5; num++) {
      let state = true
      menu += '<div style="margin-bottom : 10px; display : flex; gap: 20px;">'
      menu += `<div class="select">`
      if (num == 1) {
        menu += `<select id='menu_id_${num}' name='menu_id_${num}' required>`
      } else {
        menu += `<select id='menu_id_${num}' name='menu_id_${num}'>`
      }
      menu += `<option value="">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>`
      for (i in menuMap) {
        if (i in row.menu_list && state) {
          menu += `<option value="${i}" selected>${menuMap[i]}</option>`
          var quantity__ = row.menu_list[i]
          // console.log("qua", quantity__)
          delete row.menu_list[i]
          state = false
        }
        // console.log(row.menu_list)
        menu += `<option value="${i}">${menuMap[i]}</option>`
      }
      menu += `</select> </div> 
      <input class="input" style="max-width : 100px;"type = "number" id = "quatity_id_${num}" name = "quatity_id_${num}" placeholder = "quatity_id_${num}" min="1" value="${quantity__}" required />
      </div>`

      quantity__ = 1
      $('#menu_id_').html(menu)
      toggleView();
    }
  }

  function removeItem(row) {
    if (!confirm("Delete order with ID " + row.order_id + "?")) {
      return false;
    }
    var url = "/orders/delete";
    var formData = { order_id: row.order_id };
    $.post(url, formData, function (table_data) {
      refresh_table(table_data);
      alert("Order with ID " + row.order_id + " has been deleted.");
    }).fail(function (jqXHR, textStatus, error) {
      console.error("Failed to delete order:", textStatus, error);
    });
  }

  $("#add_order").click(function () {
    clearForm();
    toggleView();
    $('#order_id').val(orderlast + 1);
    let table_ = ""
    for (i of table_list) {
      table_ += `<option value="${i}" id="table_${i}">${i}</option>`
    }
    $('#table_id_').html(table_);
    // let list_food = {}
    // for (i in menuMap) {
    //   list_food[menuMap[i]] = i
    // }
    // console.log(list_food)
    let menu = ""
    for (let num = 1; num <= 5; num++) {
      menu += '<div style="margin-bottom : 10px; display : flex; gap: 20px;">'
      menu += `<div class="select">`
      if (num == 1) {
        menu += `<select id='menu_id_${num}' name='menu_id_${num}' required>`
      } else {
        menu += `<select id='menu_id_${num}' name='menu_id_${num}'>`
      }
      menu += `<option value="">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>`
      for (i in menuMap) {
        menu += `<option value="${i}">${menuMap[i]}</option>`
      }
      menu += `</select> </div> 
      <input class="input" style="max-width : 100px;"type = "number" id = "quatity_id_${num}" name = "quatity_id_${num}" placeholder = "quatity_id_${num}" min="1" value="1" required />
      </div>`

      $('#menu_id_').html(menu)

    }

  });

  $("#clear_form").click(function () {
    clearForm();
  });

  $("#cancel_form").click(function () {
    clearForm();
    toggleView();
  });
</script>
{% endblock %}