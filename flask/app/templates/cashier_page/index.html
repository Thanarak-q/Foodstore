{% extends 'cashier_page/base.html' %}

{% block extra_css %}
<style>
    .bootstrap-table .pagination {
        margin: 5rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }

    .bootstrap-table .page-item {
        display: inline-block;
    }

    .bootstrap-table .page-link {
        padding: 0.5rem 1rem;
        border: 1px solid #dbdbdb;
        background-color: #ffffff;
        color: #363636;
        border-radius: 4px;
        font-size: 1rem;
        text-decoration: none;
        transition: all 0.2s;
    }

    .bootstrap-table .page-item.active .page-link {
        background-color: #3273dc;
        border-color: #3273dc;
        color: #ffffff;
    }

    .bootstrap-table .page-item.disabled .page-link {
        background-color: #f5f5f5;
        color: #7a7a7a;
        cursor: not-allowed;
        opacity: 0.65;
    }

    .bootstrap-table .page-link:hover:not(.active) {
        background-color: #f5f5f5;
        color: #3273dc;
    }

    .bootstrap-table .btn-page-size {
        padding: 0.5rem 1rem;
        border: 1px solid #dbdbdb;
        background-color: #ffffff;
        color: #363636;
        border-radius: 4px;
    }

    .bootstrap-table .pagination-detail {
        display: none;
    }

    .fixed-table-toolbar .search-input {
        border: 2px solid #dbdbdb;
        border-radius: 25px;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        width: 100%;
        max-width: 300px;
    }

    .fixed-table-toolbar .search-input:focus {
        border-color: #3273dc;
        box-shadow: 0 0 5px rgba(50, 115, 220, 0.3);
        outline: none;
    }

    .fixed-table-toolbar {
        margin: 1.5rem 0;
        display: flex;
        justify-content: right;
    }
</style>

{% endblock %}

{% block content %}
<div class="section">
    <div class="container">
        <div class="card is-size-5">
            <header class="card-header">
                <h1 class="card-header-title is-size-3">Table Availability</h1>
            </header>
            <div class="card-content">
                <table id="table-list" class="table is-fullwidth is-hoverable" data-toggle="table"
                    data-pagination="true" data-search="true" paginationDetailHAlign="hidden">
                    <thead>
                        <tr>
                            <th data-field="table_id" data-sortable="true">Table No.</th>
                            <th data-field="status" data-sortable="false">Status</th>
                            <th data-field="qrcode" data-sortable="false">QR Code</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <footer class="card-footer">
                <a href="#" id="refresh" class="card-footer-item" onclick="refreshTable()">Refresh List</a>
                <a href="#" id="view-all" class="card-footer-item" style="border-right: 0px;"
                    onclick="showAllTables()">View All</a>
                <a href="#" id="view-less" class="card-footer-item" style="display: none;"
                    onclick="showLessTables()">View less</a>
            </footer>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        loadTable();
    });

    function loadTable() {
        $.getJSON('/table/get_all_table', function (data) {
            console.log("Receiving Data:", data);
            $('#table-list').bootstrapTable('destroy');
            $('#table-list').bootstrapTable({
                data: data,
                customSearch: customTableSearch,
                pagination: true,
                pageSize: 5,
                paginationDetailHAlign: "hidden",
                showPaginationSwitch: false,
                showPageList: false,
                columns: [
                    { field: 'table_id', sortable: true },
                    { field: 'status', sortable: false, formatter: statusFormatter },
                    { field: 'qrcode', sortable: false, formatter: qrcodeFormatter }
                ]
            });
        }).fail(function (jqXHR, textStatus, error) {
            console.error("Request Failed:", textStatus, error);
        });
    }

    function refreshTable() {
        $.getJSON('/table/get_all_table', function (data) {
            console.log("Refreshing Table:", data);
            $('#table-list').bootstrapTable('load', data);
        });
    }

    function statusFormatter(value) {
        if (value === "Available") {
            return '<span class="tag is-success is-size-5 has-text-weight-bold">Available</span>';
        } else if (value === "Occupied") {
            return '<span class="tag is-danger is-size-5 has-text-weight-bold">Occupied</span>';
        } else if (value === "Paid") {
            return '<span class="tag is-warning is-size-5 has-text-weight-bold">Paid</span>';
        }
        return value;
    }

    function qrcodeFormatter(value) {
        value = value.replace("app/", "");
        return `<img src="${value}" alt="QR Image" style="width: 100px; height: auto;">`;
    }

    function showAllTables() {
        $.getJSON('/table/get_all_table', function (data) {
            $('#view-all').hide();
            $('#view-less').show();
            $('#table-list').bootstrapTable('refreshOptions', { pageSize: data.length });
            $('#table-list').bootstrapTable('load', data);
        });
    }

    function showLessTables() {
        $.getJSON('/table/get_all_table', function (data) {
            $('#view-all').show();
            $('#view-less').hide();
            $('#table-list').bootstrapTable('refreshOptions', { pageSize: 5 });
            $('#table-list').bootstrapTable('load', data);
        });
    }

    function customTableSearch(data, searchText) {
        searchText = searchText.toLowerCase();
        return data.filter(row => {
            return Object.values(row).some(value => {
                if (value !== null) {
                    return value.toString().toLowerCase().includes(searchText);
                }
                return false;
            });
        });
    }
</script>
{% endblock %}