<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* คงสไตล์เดิมไว้เหมือนในโค้ดก่อนหน้า */
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }

        .invoice-container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        #store-name {
            display: flex;
            justify-content: center;
        }

        hr {
            border: none;
            border-top: 1px dashed;
            height: 2px;
            margin: 1rem 0;
            opacity: 0.7;
        }

        .circle-image {
            width: 125px;
            height: 125px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            margin: 0 auto 1rem auto;
        }

        #qrcode {
            display: flex;
            justify-content: center;
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
            }

            .invoice-container {
                width: 80mm;
                max-width: 80mm;
                margin: 0;
                padding: 5mm;
                border: none;
                box-shadow: none;
                text-align: center;
            }

            .circle-image {
                width: 40mm;
                height: 40mm;
                margin: 0 auto 5mm auto;
            }

            #store-name {
                font-size: 16pt;
                margin-bottom: 2mm;
            }

            #header-details {
                font-size: 12pt;
                margin-top: 5mm;
                text-align: center;
            }

            #details p {
                font-size: 12pt;
                margin: 5mm 0;
            }

            #qrcode img {
                width: 50mm;
                height: auto;
                margin: 5mm 0;
            }

            hr {
                margin: 5mm 0;
            }

            .button {
                display: none;
            }
        }

        .item-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
        }

        .item-name {
            font-weight: bold;
            color: #333;
            flex-basis: 30%;
        }

        .item-amount,
        .item-price,
        .item-price-per-unit {
            color: #555;
            flex-basis: 20%;
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="invoice-container" id="slip-content">
        <div id="header-container" style="margin-top: 1.5rem;">
            <img src="/static/logo/1.jpg" class="circle-image" alt="Logo" id="logo-image">
            <h1 id="store-name">{{name}}</h1>
            <h2 style="justify-content: center; display: flex;" id="header-details"
                class="is-size-4 has-text-weight-bold">ใบเสร็จ / รับเงิน</h2>
        </div>
        <h1 class="mt-5"><strong>Tax : </strong>1650614130100</h1>
        <h1><strong>พนักงาน : </strong>{{ current_user.firstname }} {{ current_user.lastname }}</h1>
        <h1><strong>เวลา :</strong><span id="time"></span></h1>

        <hr>

        <div id="content-container">
            <div id="details"></div>
        </div>
    </div>
    <div style="text-align: center; margin-top: 1.5rem;">
        <a href="#" id="print-qr-button" style="width: 11.5rem;"
            class="button is-medium is-link has-text-weight-bold is-responsive mr-3">
            พิมพ์ใบเสร็จ
        </a>
        <a href="#" id="confirm-button" style="width: 11.5rem;"
            class="button is-medium has-text-weight-bold is-responsive mr-3 is-success">
            ยืนยันการชำระเงิน
        </a>
        <a href="/cashier" id="home-button" class="button is-medium has-text-weight-bold is-responsive"
            style="background-color: coral; color: white; width: 11.5rem">
            กลับหน้าหลัก
        </a>
    </div>

    <script>
        const localDate = new Date();

        $(document).ready(function () {
            let table_id_ = '{{table_id}}';
            const formattedUtcDate = new Intl.DateTimeFormat('th-TH', {
                weekday: 'long',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
            }).format(localDate);
            $('#time').text(`${formattedUtcDate} น.`);

            // Load invoice details
            updateDetails(table_id_);

            // Print button with auto height
            $("#print-qr-button").on("click", function (e) {
                e.preventDefault();
                const element = document.getElementById("slip-content");
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    const { jsPDF } = window.jspdf;
                    const pdfWidth = 80;
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    const pdf = new jsPDF({
                        orientation: "portrait",
                        unit: "mm",
                        format: [pdfWidth, pdfHeight]
                    });
                    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
                    const printWindow = window.open(pdf.output("bloburl"), "_blank");
                    printWindow.onload = function () {
                        printWindow.print();
                        setTimeout(() => {
                            printWindow.close();
                        }, 3000);
                    };
                }).catch(error => {
                    console.error("Error generating PDF:", error);
                    alert("เกิดข้อผิดพลาดในการสร้างบิล กรุณาตรวจสอบคอนโซล");
                });
            });

            // Home button with payment confirmation
            $("#confirm-button").on("click", function (e) {
                var sumprice;
                $.post('/payment/create_slip', { table_id: table_id_ }, function (table_data) {
                    sumprice = table_data['total'] + table_data['vat_7%'];
                });

                e.preventDefault();

                Swal.fire({
                    title: "ชำระเงินแล้วใช่หรือไม่?",
                    text: `โต๊ะ ${table_id_} ได้ชำระเงินเรียบร้อยแล้วหรือยัง?`,
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "ชำระแล้ว",
                    cancelButtonText: "ยังไม่ชำระ"
                }).then((paymentResult) => {
                    if (paymentResult.isConfirmed) {
                        let payment_data = {
                            table_id: table_id_,
                            payment_method: "{{payment_method}}",
                            amount: sumprice,
                            payment_time: localDate.toISOString()
                        }
                        console.log("Sending data:", payment_data);
                        $.post('/payment/create', payment_data, function () {
                            Swal.fire("สำเร็จ!", "สถานะโต๊ะอัปเดตเรียบร้อย", "success")
                                .then(() => {
                                    window.location.href = "/cashier";
                                });

                        }).fail(function (error) {
                            console.error("Error create slip:", "error");
                        });


                    } else {
                        console.log("ผู้ใช้ระบุว่ายังไม่ชำระเงิน");
                        Swal.fire("แจ้งเตือน", "กรุณาชำระเงินก่อนดำเนินการต่อ", "warning");
                    }
                });
            });

            function updateDetails(table_id_) {
                console.log("Fetching store data...");
                $.getJSON("/store_list", function (data) {
                    $("#store-name").html(data[0].name);
                });

                $.post('/payment/create_slip', { table_id: table_id_ }, function (table_data) {
                    const sumprice = table_data['sum_price'];
                    const total = table_data['total'];
                    const vat = table_data['vat_7%'];
                    create_list(sumprice, total, vat);
                });
            }

            function create_list(data, total, vat) {
                let totalamout = 0;
                if (typeof data !== 'object' || data === null) {
                    console.error('Expected an object with item data');
                    $('#details').html('<p>Error: No item data available</p>');
                    return;
                }

                let listItems = '<ul class="item-list">';
                listItems += `<li class="item"> 
                    <span class="item-name">ชื่อเมนู</span>
                    <span class="item-amount">จำนวน</span>
                    <span class="item-price-per-unit">ราคาต่อชิ้น</span>
                    <span class="item-price">ราคารวม</span>
                </li><hr/>`;

                Object.entries(data).forEach(([key, item], index) => {
                    let amount = item.amount || 'N/A';
                    let price = parseFloat(item.price).toFixed(2) || 'N/A';
                    let pricePerUnit = parseFloat(item.price_per_unit).toFixed(2) || 'N/A';
                    totalamout += amount;
                    listItems += `
                <li class="item">
                    <span class="item-name">${key || 'Unnamed'}</span>
                    <span class="item-amount">${amount}</span>
                    <span class="item-price-per-unit">${pricePerUnit}</span>
                    <span class="item-price">${price}</span>
                </li>
            `;
                });

                listItems += `
                    <hr>
                <li class="item">
                    <span class="item-name">ราคาไม่รวม vat</span>
                    <span class="item-amount"></span>
                    <span class="item-price-per-unit"></span>
                    <span class="item-price">${parseFloat(total).toFixed(2)}</span>
                </li>
            `;

                listItems += `
                <li class="item">
                    <span class="item-name">vat 7%</span>
                    <span class="item-amount"></span>
                    <span class="item-price-per-unit"></span>
                    <span class="item-price">${(vat).toFixed(2)}</span>
                </li>
            `;

                listItems += `
                <li class="item">
                    <span class="item-name">ราคารวม vat 7%</span>
                    <span class="item-amount"></span>
                    <span class="item-price-per-unit"></span>
                    <span class="item-price">${(vat + total).toFixed(2)}</span>
                </li>
            `;

                listItems += `
                <li class="item">
                    <span class="item-name">ราคารวม vat 7% (ปัดเศษ)</span>
                    <span class="item-amount"></span>
                    <span class="item-price-per-unit"></span>
                    <span class="item-price">${Math.floor(vat + total)}</span>
                </li>
            `;

                listItems += `
                    <hr>
                <div style="display: flex; justify-content: center;">
                    <p>ขอบคุณที่มาใช้บริการครับ/ค่ะ</p>
                </div>
            `;

                listItems += '</ul>';
                $('#details').html(listItems);
            }
        });
    </script>
</body>

</html>